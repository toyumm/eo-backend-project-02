<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${postDto.title}">ê²Œì‹œê¸€</title>

    <!-- index.css ê·¸ëŒ€ë¡œ ì‚¬ìš© -->
    <link rel="stylesheet" href="/css/index.css">
    <script src="/js/index.js" defer></script>

    <!-- CSRF -->
    <meta name="_csrf" th:content="${_csrf?.token}">
    <meta name="_csrf_header" th:content="${_csrf?.headerName}">

    <style>
        /* ====== read ì „ìš© ìŠ¤íƒ€ì¼ ====== */
        .post-box {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 26px;
            margin-bottom: 18px;
        }

        .post-title {
            font-size: 22px;
            font-weight: bold;
            color: #333;
            margin-bottom: 14px;
        }

        .post-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            font-size: 13px;
            color: #666;
            padding: 12px 0;
            border-top: 2px solid #333;
            border-bottom: 1px solid #ddd;
            margin-bottom: 18px;
        }

        .post-content {
            min-height: 260px;
            white-space: pre-wrap;
            line-height: 1.8;
            font-size: 15px;
            color: #333;
        }

        .post-actions {
            margin-top: 18px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn {
            padding: 10px 14px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background: #fff;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            text-decoration: none;
            color: #333;
        }
        .btn:hover { background: #f0f0f0; }
        .btn-danger {
            border-color: #dc3545;
            color: #dc3545;
        }
        .btn-danger:hover { background: #fff0f1; }

        /* ===== ëŒ“ê¸€ ì˜ì—­ ===== */
        .comment-box {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
        }

        .comment-head {
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom: 12px;
        }
        .comment-head h3 {
            font-size: 16px;
            margin: 0;
            color: #333;
        }
        .comment-total {
            font-size: 13px;
            color: #666;
        }

        .comment-form textarea{
            width:100%;
            min-height: 90px;
            border:1px solid #ddd;
            border-radius: 6px;
            padding: 12px;
            font-size: 14px;
            resize: vertical;
        }

        .comment-form .form-actions{
            display:flex;
            justify-content:flex-end;
            margin-top: 10px;
        }


        .comment-item {
            padding: 16px 0;
            border-top: 1px solid #eee;
        }
        .comment-item:first-child { border-top: none; }

        .comment-body { width: 100%; }

        .comment-top {
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap: 10px;
        }
        .comment-writer {
            font-weight: bold;
            font-size: 14px;
            color:#333;
        }
        .comment-time {
            font-size: 12px;
            color:#888;
            white-space: nowrap;
        }

        .comment-content {
            margin-top: 8px;
            font-size: 14px;
            white-space: pre-wrap;
            line-height: 1.6;
            color:#333;
        }

        .comment-footer {
            margin-top: 10px;
            display:flex;
            justify-content:flex-end;
            align-items:center;
            gap: 8px;
        }

        .comment-actions {
            display:flex;
            gap:8px;
        }

        .comment-actions button {
            padding: 7px 12px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background:#fff;
            cursor:pointer;
            font-size: 12px;
            font-weight:bold;
        }
        .comment-actions button:hover { background:#f0f0f0; }

        .comment-actions .del {
            color:#dc3545;
            border-color:#f2b8bf;
        }
        .comment-actions .del:hover { background:#fff0f1; }

        .comment-editbox { display:none; margin-top:10px; }
        .comment-editbox textarea {
            width:100%;
            min-height: 80px;
            border:1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
        }
        .comment-editbox .row {
            display:flex;
            justify-content:flex-end;
            gap:8px;
            margin-top: 8px;
        }

        .empty-comment {
            padding: 18px 0;
            color:#888;
            text-align:center;
        }

        .error-text {
            color:#dc3545;
            font-size: 13px;
            margin-top: 8px;
            display:none;
        }
    </style>

    <!-- JSì—ì„œ postId, ë¡œê·¸ì¸ ì •ë³´ ì‚¬ìš© -->
    <script th:inline="javascript">
        const postId = /*[[${postDto.id}]]*/ 1;

        // ë¡œê·¸ì¸í•œ ì‚¬ìš©ì id (ì—†ìœ¼ë©´ null)
        const currentUserId =
            /*[[${#authentication?.principal instanceof T(com.example.community.security.CustomUserDetails)
                ? #authentication.principal.id
                : null}]]*/ null;

        // ê´€ë¦¬ì ì—¬ë¶€
        const isAdmin = /*[[${#authorization.expression("hasRole('ADMIN')")}]]*/ false;
    </script>
</head>

<body>
<div id="wrapper">

    <!-- í—¤ë” -->
    <header id="header">
        <div id="logo">
            <a th:href="@{/}">
                <img src="/images/logo.png" alt="ë¡œê³ ">
            </a>
        </div>
        <div id="banner"></div>
    </header>

    <!-- ë©”ì¸ ë ˆì´ì•„ì›ƒ -->
    <div id="main-layout">

        <!-- ì™¼ìª½ ì‚¬ì´ë“œë°” (indexì™€ ë™ì¼í•˜ê²Œ ìœ ì§€) -->
        <aside id="left-sidebar">
            <div class="sidebar-section">
                <h3>
                    ê³µì§€ì‚¬í•­
                    <a th:href="@{/admin/board/create(category='NOTICE')}"
                       class="add-board-btn"
                       aria-label="ê³µì§€ì‚¬í•­ ì¶”ê°€"
                       sec:authorize="hasRole('ADMIN')">
                        <span>ê³µì§€ ì¹´í…Œê³ ë¦¬ ì¶”ê°€</span>
                    </a>
                </h3>
                <ul class="sidebar-menu">
                    <li th:each="board : ${noticeBoardList}">
                        <a th:href="@{/board/{boardId}/post/list(boardId=${board.id})}"
                           th:text="${board.title}">ê³µì§€ ì¹´í…Œê³ ë¦¬</a>
                    </li>

                    <li th:if="${noticeBoardList == null || #lists.isEmpty(noticeBoardList)}">
                        <span>ë“±ë¡ëœ ê³µì§€ ì¹´í…Œê³ ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</span>
                    </li>
                </ul>
            </div>

            <div class="sidebar-section">
                <h3>ğŸ“‹ ê²Œì‹œíŒ
                    <a th:href="@{/admin/board/create}"
                       class="add-board-btn"
                       aria-label="ê²Œì‹œíŒ ì¶”ê°€"
                       sec:authorize="hasRole('ADMIN')">
                        <span>ê²Œì‹œíŒ ì¶”ê°€</span>
                    </a>
                </h3>
                <ul class="sidebar-menu">
                    <th:block th:each="board : ${boardList}">
                        <li>
                            <a th:href="@{/board/{boardId}/post/list(boardId=${board.id})}"
                               th:text="${board.title}">ê²Œì‹œíŒ</a>
                        </li>
                    </th:block>
                </ul>
            </div>
        </aside>

        <!-- ì¤‘ì•™ ë©”ì¸ ì»¨í…ì¸  -->
        <main id="main-content">

            <!-- ===== ê²Œì‹œê¸€ ìƒì„¸ ===== -->
            <div class="post-box" th:object="${postDto}">
                <div class="post-title" th:text="*{title}">ì œëª©</div>

                <div class="post-meta">
                    <span><strong>ì‘ì„±ì:</strong> <span th:text="*{writer}">writer</span></span>
                    <span><strong>ì‘ì„±ì¼:</strong> <span th:text="*{#temporals.format(createdAt,'yyyy-MM-dd HH:mm')}">date</span></span>
                    <span><strong>ì¡°íšŒìˆ˜:</strong> <span th:text="*{viewCount}">0</span></span>
                    <span><strong>ì¢‹ì•„ìš”:</strong> <span th:text="*{likesCount}">0</span></span>
                    <span><strong>ëŒ“ê¸€:</strong> <span th:text="*{commentsCount}">0</span></span>
                </div>

                <div class="post-content" th:text="*{content}">ë³¸ë¬¸</div>

                <div class="post-actions">

                    <a class="btn" th:href="@{/}">
                        ëª©ë¡
                    </a>

                    <!-- ì‘ì„±ìë§Œ ìˆ˜ì • (ê´€ë¦¬ìëŠ” ìˆ˜ì • ë¶ˆê°€) -->
                    <a class="btn"
                       sec:authorize="isAuthenticated()"
                       th:if="${postDto.userId} != null
                              and ${#authentication.principal instanceof T(com.example.community.security.CustomUserDetails)}
                              and ${postDto.userId} == ${#authentication.principal.id}
                              and !${#authorization.expression('hasRole(''ADMIN'')')}"
                       th:href="@{/board/{boardId}/post/update(boardId=${postDto.boardId}, id=${postDto.id})}">
                        ìˆ˜ì •
                    </a>

                    <!-- ì‘ì„±ì ë˜ëŠ” ê´€ë¦¬ì ì‚­ì œ (ê´€ë¦¬ìëŠ” ì‚­ì œë§Œ) -->
                    <form sec:authorize="isAuthenticated()"
                          th:if="(${postDto.userId} != null
                                  and ${#authentication.principal instanceof T(com.example.community.security.CustomUserDetails)}
                                  and ${postDto.userId} == ${#authentication.principal.id})
                                or ${#authorization.expression('hasRole(''ADMIN'')')}"
                          th:action="@{/board/{boardId}/post/delete(boardId=${postDto.boardId}, id=${postDto.id})}"
                          method="post"
                          onsubmit="return confirm('ê²Œì‹œê¸€ì„ ì‚­ì œí• ê¹Œìš”?');">
                        <button class="btn btn-danger" type="submit">ì‚­ì œ</button>
                    </form>
                </div>
            </div>

            <!-- ===== ëŒ“ê¸€ ì˜ì—­ ===== -->
            <div class="comment-box">
                <div class="comment-head">
                    <h3>ëŒ“ê¸€</h3>
                    <div class="comment-total">ì´ <span id="commentCount">0</span>ê°œ</div>
                </div>

                <!-- ë¡œê·¸ì¸ ì‹œ ëŒ“ê¸€ ì‘ì„± -->
                <div class="comment-form" sec:authorize="isAuthenticated()">
                    <textarea id="newComment" maxlength="200" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”. (1~200ì)"></textarea>
                    <div class="form-actions">
                        <button class="btn" id="btnCreateComment" type="button">ë“±ë¡</button>
                    </div>
                    <div class="error-text" id="commentError"></div>
                </div>

                <!-- ë¹„ë¡œê·¸ì¸ ì•ˆë‚´ -->
                <div class="empty-comment" sec:authorize="isAnonymous()">
                    ëŒ“ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸í•˜ì„¸ìš”.
                </div>

                <div id="commentList"></div>
                <div class="empty-comment" id="emptyCommentMsg" style="display:none;">
                    ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.
                </div>
            </div>

        </main>

        <!-- ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°” (indexì™€ ë™ì¼í•˜ê²Œ ìœ ì§€) -->
        <aside id="right-sidebar">

            <div id="auth-box" sec:authorize="!isAuthenticated()">
                <h3>ë¡œê·¸ì¸</h3>
                <form th:action="@{/login}" method="post">
                    <input type="text" name="username" placeholder="ì•„ì´ë””" autocomplete="username" required>
                    <input type="password" name="password" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password" required>
                    <button type="submit">ë¡œê·¸ì¸</button>
                </form>
                <div class="auth-links">
                    <a th:href="@{/signup}">íšŒì›ê°€ì…</a>
                    <a th:href="@{/find-password}">ID/PW ì°¾ê¸°</a>
                </div>
            </div>

            <div id="auth-box2" sec:authorize="isAuthenticated()">
                <div class="user-info">
                    <p><span sec:authentication="name">ì‚¬ìš©ì</span>ë‹˜</p>
                    <div class="profile-links">
                        <a th:href="@{/mypage}">ë§ˆì´í˜ì´ì§€</a>
                        <a th:href="@{/messages}">ìª½ì§€í•¨</a>
                        <a sec:authorize="hasRole('ADMIN')" th:href="@{/admin/dashboard}">ê´€ë¦¬ì</a>
                        <form th:action="@{/logout}" method="post" onsubmit="return confirmLogout();">
                            <button type="submit">ë¡œê·¸ì•„ì›ƒ</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- ì¸ê¸° ê²Œì‹œê¸€ ë­í‚¹ -->
            <div id="ranking-section">
                <h3>ì¸ê¸° ê²Œì‹œê¸€</h3>
                <ul class="ranking-list">
                    <li class="ranking-item">
                        <span class="ranking-number">1</span>
                        <a href="#" title="ì¸ê¸° ê²Œì‹œê¸€ ì œëª©ì…ë‹ˆë‹¤">ì¸ê¸° ê²Œì‹œê¸€ ì œëª©ì…ë‹ˆë‹¤</a>
                        <span class="ranking-views">1.2k</span>
                    </li>
                </ul>
            </div>

        </aside>
    </div>

    <footer id="footer">
        <p><strong>ë°±ì—”ë“œ ê°œë°œì ì–‘ì„±ê³¼ì • 2ì°¨ í”„ë¡œì íŠ¸</strong></p>
        <p>Community Platform Â© 2026 All rights reserved.</p>
    </footer>

</div>

<script>
    const COMMENT_API = `/api/posts/${postId}/comments`;

    const $list = document.getElementById('commentList');
    const $count = document.getElementById('commentCount');
    const $empty = document.getElementById('emptyCommentMsg');

    const $new = document.getElementById('newComment');
    const $btnCreate = document.getElementById('btnCreateComment');
    const $err = document.getElementById('commentError');

    function getCsrf() {
        const token = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
        const header = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');
        if (!token || !header) return null;
        return { token, header };
    }

    function withCsrf(headers = {}) {
        const csrf = getCsrf();
        if (!csrf) return headers;
        return { ...headers, [csrf.header]: csrf.token };
    }

    async function fetchJson(url, options = {}) {
        const res = await fetch(url, {
            credentials: 'same-origin',
            ...options,
            headers: withCsrf({
                'Content-Type': 'application/json',
                ...(options.headers || {})
            })
        });

        if (res.status === 401) throw new Error('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        if (res.status === 403) throw new Error('ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
        if (res.status === 404) throw new Error('ìš”ì²­í•œ ë¦¬ì†ŒìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        if (!res.ok) {
            const t = await res.text();
            throw new Error(t || `HTTP ${res.status}`);
        }
        if (res.status === 204) return null;
        return res.json();
    }

    function formatDateTime(iso) {
        if (!iso) return '';
        const d = new Date(iso);
        const yy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        const hh = String(d.getHours()).padStart(2, '0');
        const mi = String(d.getMinutes()).padStart(2, '0');
        return `${yy}.${mm}.${dd} ${hh}:${mi}`;
    }

    function escapeHtml(str) {
        return String(str)
            .replaceAll('&','&amp;')
            .replaceAll('<','&lt;')
            .replaceAll('>','&gt;')
            .replaceAll('"','&quot;')
            .replaceAll("'","&#039;");
    }


    function render(comments) {
        $count.textContent = String(comments.length);
        $empty.style.display = comments.length ? 'none' : 'block';

        $list.innerHTML = comments.map(c => {
            const isOwner = (currentUserId != null && Number(c.userId) === Number(currentUserId));
            const showDelete = isOwner || isAdmin;
            const showEdit = isOwner && !isAdmin;

            return `
                <div class="comment-item" id="comment-${c.id}" data-id="${c.id}">
                    <div class="comment-body">
                        <div class="comment-top">
                            <div class="comment-writer">${escapeHtml(c.writer ?? 'unknown')}</div>
                            <div class="comment-time">${formatDateTime(c.createdAt)}</div>
                        </div>

                        <div class="comment-content" data-content>${escapeHtml(c.content ?? '')}</div>

                        <div class="comment-editbox" data-editbox>
                            <textarea maxlength="200"></textarea>
                            <div class="row">
                                <button type="button" data-action="cancel">ì·¨ì†Œ</button>
                                <button type="button" data-action="save">ì €ì¥</button>
                            </div>
                        </div>

                        <div class="comment-footer" style="${(showEdit || showDelete) ? '' : 'display:none'}">
                            <div class="comment-actions">
                                ${showEdit ? `<button type="button" data-action="edit">ìˆ˜ì •</button>` : ``}
                                ${showDelete ? `<button type="button" class="del" data-action="delete">ì‚­ì œ</button>` : ``}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    async function loadComments() {
        const data = await fetchJson(COMMENT_API, { method: 'GET' });
        render(Array.isArray(data) ? data : []);
    }

    async function createComment() {
        if (!$new) return;

        const content = $new.value.trim();
        $err.style.display = 'none';
        $err.textContent = '';

        if (content.length < 1 || content.length > 200) {
            $err.style.display = 'block';
            $err.textContent = 'ëŒ“ê¸€ì€ 1~200ìì—¬ì•¼ í•©ë‹ˆë‹¤.';
            return;
        }

        await fetchJson(COMMENT_API, {
            method: 'POST',
            body: JSON.stringify({ content })
        });

        $new.value = '';
        await loadComments();
    }

    function openEditBox($item) {
        const $editBox = $item.querySelector('[data-editbox]');
        const $content = $item.querySelector('[data-content]');
        const $ta = $editBox.querySelector('textarea');

        $ta.value = $content.textContent.trim();
        $editBox.style.display = 'block';
        $content.style.display = 'none';
    }

    function closeEditBox($item) {
        const $editBox = $item.querySelector('[data-editbox]');
        const $content = $item.querySelector('[data-content]');
        $editBox.style.display = 'none';
        $content.style.display = 'block';
    }

    async function saveEdit($item) {
        if (isAdmin) {
            alert('ê´€ë¦¬ìëŠ” ëŒ“ê¸€ì„ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        const id = $item.dataset.id;
        const $editBox = $item.querySelector('[data-editbox]');
        const $ta = $editBox.querySelector('textarea');
        const content = $ta.value.trim();

        if (content.length < 1 || content.length > 200) {
            alert('ëŒ“ê¸€ì€ 1~200ìì—¬ì•¼ í•©ë‹ˆë‹¤.');
            return;
        }

        await fetchJson(`${COMMENT_API}/${id}`, {
            method: 'PUT',
            body: JSON.stringify({ id: Number(id), postId: postId, content })
        });

        await loadComments();
    }

    async function deleteComment(id) {
        if (!confirm('ëŒ“ê¸€ì„ ì‚­ì œí• ê¹Œìš”?')) return;
        await fetchJson(`${COMMENT_API}/${id}`, { method: 'DELETE' });
        await loadComments();
    }

    window.addEventListener('load', async () => {
        await loadComments();

        if ($btnCreate) $btnCreate.addEventListener('click', async () => {
            try { await createComment(); }
            catch (e) {
                $err.style.display = 'block';
                $err.textContent = e.message;
            }
        });

        $list.addEventListener('click', async (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;

            const $item = e.target.closest('.comment-item');
            if (!$item) return;

            const action = btn.dataset.action;

            try {
                if (action === 'edit') openEditBox($item);
                if (action === 'cancel') closeEditBox($item);
                if (action === 'save') await saveEdit($item);
                if (action === 'delete') await deleteComment($item.dataset.id);
            } catch (err) {
                alert(err.message || 'ìš”ì²­ ì‹¤íŒ¨');
            }
        });
    });
</script>

</body>
</html>
